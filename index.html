<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <title>Generador de Orden de Compra - Hard Hat Solutions</title>
    <link rel="stylesheet" href="styles.css">
    <style>
        body { font-family: Arial, sans-serif; margin: 20px; background: #f4f4f4; }
        .control-panel { background: white; padding: 20px; border-radius: 8px; box-shadow: 0 2px 10px rgba(0,0,0,0.1); max-width: 400px; float: left; margin-right: 20px; }
        .page { background: white; padding: 20px; border: 1px solid #ddd; max-width: 800px; margin-top: 20px; box-sizing: border-box; }
        button, select, input { margin: 5px 0; width: 100%; padding: 8px; box-sizing: border-box; }
        .btn-print { background: #0066cc; color: white; padding: 12px 30px; border: none; cursor: pointer; font-size: 16px; border-radius: 6px; }
        .btn-print:hover { background: #0055aa; }

        /* EVITA QUE EL PDF SE CORTE */
        table, tr, td, .totals-section, .footer-notes, .notes, .signatures, .info-grid, .oc-box, .items-table thead, .items-table tbody {
            page-break-inside: avoid !important;
        }
        tr { page-break-inside: avoid !important; page-break-after: auto; }
        .page { page-break-after: always; }

        /* Media print mejorado */
        @media print {
            .no-print { display: none; }
            .page {
                margin: 0;
                border: none !important;
                box-shadow: none !important;
                padding: 20px;
            }
        }

        /* Sección OCs guardadas */
        .ocs-section { margin-top: 30px; background: #f9f9f9; padding: 15px; border-radius: 6px; }
        .ocs-list { max-height: 200px; overflow-y: auto; }
        .oc-item { padding: 8px; border-bottom: 1px solid #ddd; display: flex; justify-content: space-between; align-items: center; }
        .oc-item button { width: auto; margin-left: 10px; }
    </style>
</head>
<body>

    <!-- Tu panel de control y página (sin cambios mayores, solo agregué la sección de OCs guardadas y edición de número) -->
    <!-- ... (el HTML que ya tenías, incluyendo el nuevo input para editar número OC y la sección de OCs guardadas) ... -->

    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>

    <script>
        // ... (todas tus funciones existentes: formatearMoneda, proveedores, obras, items, notas, etc.) ...

        // === FUNCIÓN generarPDF MEJORADA ===
        function generarPDF() {
            const obra = document.getElementById('dispObra').textContent.trim() || 'Sin Obra';
            const numeroOC = document.getElementById('ocNum').textContent;
            const nombreArchivo = `${obra} , OC N°${numeroOC}.pdf`;

            const element = document.querySelector('.page');

            // Guardar estilos originales y quitar border/shadow para PDF limpio
            const borderOriginal = element.style.border;
            const shadowOriginal = element.style.boxShadow;
            element.style.border = 'none';
            element.style.boxShadow = 'none';

            const opt = {
                margin: 0.2, // Márgenes pequeños para aprovechar toda la hoja
                filename: nombreArchivo,
                image: { type: 'jpeg', quality: 0.98 },
                html2canvas: {
                    scale: 2,
                    useCORS: true,
                    letterRendering: true,
                    scrollY: 0 // Evita corte si hay scroll en la página
                },
                jsPDF: {
                    unit: 'in',
                    format: 'a4', // A4 es más estándar en Chile y evita cortes laterales
                    orientation: 'portrait'
                },
                pagebreak: {
                    mode: ['avoid-all', 'css', 'legacy'],
                    avoid: 'tr' // Lo más importante: evita cortar filas de tabla
                }
            };

            html2pdf().set(opt).from(element).save().then(() => {
                // Restaurar estilos originales
                element.style.border = borderOriginal;
                element.style.boxShadow = shadowOriginal;

                // Guardar la OC en localStorage y avanzar número
                guardarOC();
                numeroActual++;
                localStorage.setItem(KEY_OC, numeroActual);
                actualizarNumeroOC();
            });
        }

        // ... (el resto de tu script sin cambios) ...
    </script>
</body>
</html>